<!--
@key 6
@title Django ä¸­å›¾ç‰‡çš„ä¸Šä¼ åŠæ˜¾ç¤º
@date 2018-5-4
@labels Django Python
@description å¤„ç†é™æ€èµ„æºå¯¹äºä¸€ä¸ªç«™ç‚¹æ¥è¯´æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå¯¹äº Django æ¥è¯´ï¼Œå®ƒæœ‰ä¸€å¥—è‡ªå·±è§„å®šçš„é™æ€èµ„æºç®¡ç†æ–¹æ³•ï¼Œå¦‚æœéœ€è¦åœ¨ Django ä¸­æ¿€æ´»å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼Œä¸ä½†éœ€è¦è‡ªå·±å†™ä¸€ä¸ª Controller æ¥å®Œæˆæ–‡ä»¶çš„æ¥å—ï¼Œè¿˜éœ€è¦ä½¿ç”¨é¢å¤–çš„æ•°æ®åº“èµ„æºæ¥å­˜å‚¨æ–‡ä»¶ï¼Œæœ¬æ–‡å°†é˜è¿°å¦‚ä½•ä½¿ç”¨ Django æ¥å—ã€ä¿å­˜å¹¶è¿”å›å›¾ç‰‡ã€‚
-->

åœ¨ `Django` ä¸­ï¼Œä¸Šä¼ æ–‡ä»¶ä¸åŒäºæ™®é€šæœåŠ¡å™¨çš„ä¸Šä¼ æ–¹æ³•ï¼Œåœ¨æ™®é€šæœåŠ¡å™¨ä¸­åªéœ€è¦ä½¿ç”¨ä¸€ä¸ª `Controller` æ¥æ§åˆ¶æ–‡ä»¶çš„ä¸Šä¼ å³å¯å®Œæˆï¼Œä½†æ˜¯åœ¨ `Django` ä¸­ï¼Œåˆ™éœ€è¦é¢å¤–ä½¿ç”¨æ•°æ®åº“èµ„æºæ¥å­˜å‚¨æ–‡ä»¶ã€‚æœ¬æ–‡å°†è¯´æ˜å¦‚ä½•ä½¿ç”¨ `Django` æ¥æ”¶ã€ä¿å­˜å¹¶ä¸”è¿”å›å›¾ç‰‡ã€‚

# â˜• å‡†å¤‡
é¦–å…ˆï¼Œä½ éœ€è¦ä¸ºä½ çš„ `Python` å®‰è£… `pillow`ï¼Œ`pillow` æ˜¯ä¸€ä¸ª `Python` å›¾åƒåº“ï¼Œ`Django` çš„å›¾ç‰‡æ–¹é¢çš„åŠŸèƒ½ä½¿ç”¨åˆ°äº†å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦äº‹å…ˆå®‰è£…ï¼š

```
pip install pillow
```

å®‰è£…å®Œæˆä¹‹åæˆ‘ä»¬éœ€è¦åœ¨ `Django` çš„ `settings.py` ä¸­æ›´æ”¹ä¸€äº›è®¾ç½®ï¼š

```python
# settings.py
# åœ¨æœ«å°¾æ·»åŠ 

MEDIA_ROOT = os.path.join(BASE_DIR, 'media').replace('\\', '/')

MEDIA_URL = '/media/'
```

# ğŸ« Model
ä¹‹å‰è¯´åˆ°äº† `Django` çš„å›¾ç‰‡éœ€è¦ä½¿ç”¨é¢å¤–çš„æ•°æ®åº“èµ„æºæ¥å­˜å‚¨æ–‡ä»¶ï¼Œè¿™æ ·çš„è®¾å®šå¹¶ä¸æ˜¯æŠŠå›¾ç‰‡æ•°æ®æœ¬èº«å­˜åœ¨æ•°æ®åº“ï¼Œè€Œæ˜¯ `Django` å°†ä¼šè‡ªåŠ¨å°†æ–‡ä»¶ä¸Šä¼ åˆ°ä½ è®¾ç½®çš„ä½ç½®ï¼Œå¹¶ä¸”æŠŠä¸Šä¼ ä¹‹åçš„å›¾ç‰‡ `path` å­˜å…¥æ•°æ®åº“ï¼Œè¿™æ ·ä½ åªéœ€è¦è®¿é—®æ•°æ®åº“ä¸­çš„ `path` å³å¯è®¿é—®åˆ°å›¾ç‰‡ã€‚

åœ¨ä½ çš„åº”ç”¨ç›®å½•ä¸‹çš„ `models.py` é‡Œæ–°å»ºä¸€ä¸ªå›¾ç‰‡ `Model`

```python
from django.db import models

class Image(models.Model):
    # å›¾ç‰‡
    img = models.ImageField(upload_to='img')
    # åˆ›å»ºæ—¶é—´
    time = models.DateTimeField(auto_now_add=True)
```

è¿™æ ·åšä¹‹åï¼Œä¸€æ—¦æ•°æ®åº“å¯¹è±¡è¢«åˆ›å»ºï¼Œ`img` è¡¨åˆ—æ¥å—çš„å›¾ç‰‡å¯¹è±¡å°†ä¼šè‡ªåŠ¨è¢«ä¸Šä¼ åˆ° `/media/img` æ–‡ä»¶å¤¹ä¸­ï¼Œåœ¨ä¸Šä¼ å®Œæˆä¹‹åï¼Œ`img` å°†ä¼šä¿å­˜å›¾ç‰‡çš„ `path`ã€‚

# ğŸ§€ View
ä¸»æµæœåŠ¡å™¨æ¥å—æ–‡ä»¶éƒ½éœ€è¦è‡ªå·±å†™ä¸€ä¸ªå“åº”ï¼Œ`Django` ä¹Ÿä¸ä¾‹å¤–ã€‚

åœ¨ä½ çš„åº”ç”¨ä¸‹çš„ `views.py` ä¸­æ–°å»ºä¸€ä¸ªå“åº”:

```python
from .models import Image
from django.shortcuts import HttpResponse
import json

MEDIA_SERVER = 'http://127.0.0.1:8000/media/'

class ImageTool:
    @staticmethod
    def get_new_random_file_name(file_name):
        find_type = False
        for c in file_name:
            if c == '.':
                find_type = True
        if find_type:
            type = file_name.split('.')[-1]
            return str(uuid.uuid1()) + '.' + type
        else:
            return str(uuid.uuid1())


def image_upload(request):
    source = request.FILES.get('image')
    if source:
      source.name = ImageTool.get_new_random_file_name(source.name)
      image = Image(
          img=source
      )
      image.save()
      return HttpResponse(json.dumps({
          'success': True,
          'path': MEDIA_SERVER + image.img.url
      }))
  else:
      return HttpResponse(json.dumps({
          'success': False,
          'error_code': 100
      }))
```

å“åº”çš„ä¸»ä½“æ˜¯ `image_upload` æ–¹æ³•ï¼Œè€Œ `ImageTool` ä¸­ `get_new_random_file_name` æ–¹æ³•æ˜¯ä¸ºäº†è·å–ä¸€ä¸ªæ–°çš„ `uuid` éšæœºæ–°åå­—ï¼Œè¿™æ ·åšçš„åŸå› æ˜¯å› ä¸ºå›¾ç‰‡å¯èƒ½æœ‰é‡åçš„çŠ¶å†µï¼Œè™½ç„¶å¦‚æœé‡åˆ°è¿™æ ·çš„äº‹æƒ… `Django` ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬å¤„ç†ï¼Œä½†æ˜¯ä¸ºäº†ä¿æŒåå­—çš„å¯ç®¡ç†æ€§å’Œç»Ÿä¸€æ€§ï¼Œè‡ªå·±å†™ä¸€ä¸ªé‡å‘½åçš„æ–¹æ³•ä¼šæ›´å¥½ã€‚

# ğŸ— Url
æœ€ååªéœ€è¦åœ¨ `url` ä¸­æ·»åŠ æ–‡ä»¶ä¸Šä¼  `view` çš„ `url` å³å¯:

```python
# urls.py

from django.urls import path
from . import views

urlpatterns = [
    ...

    path('file/image_upload', views.file__image_upload)
]
```

# ğŸ‰ ä¸Šä¼ å›¾ç‰‡å’Œè®¿é—®å›¾ç‰‡
å®Œæˆè¿™äº›åï¼Œä½ åªéœ€è¦åœ¨å‰ç«¯éœ€è¦ä¸Šä¼ å›¾ç‰‡çš„åœ°æ–¹å°† `url` æŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œå°±èƒ½å°†å›¾ç‰‡æˆåŠŸä¸Šä¼ ï¼Œä¸Šä¼ å®Œæˆä¹‹åä½ å¯ä»¥ä½¿ç”¨ `/media/` åŠ ä¸Šæ•°æ®åº“ä¸­å›¾ç‰‡çš„ `path` å°±èƒ½è®¿é—®åˆ°å›¾ç‰‡ã€‚
